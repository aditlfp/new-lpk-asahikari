name: Build & Deploy Vite to cPanel

on:
  push:
    branches: [ main ]

jobs:
  # =========================
  # 1Ô∏è‚É£ BUILD JOB
  # =========================
  build:
    name: Build Vite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Build project
        env:
          VITE_URL_SIGNUP: ${{ secrets.VITE_URL_SIGNUP }}
          VITE_URL_SIGIN: ${{ secrets.VITE_URL_SIGIN }}
        run: npm run build

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist

  # =========================
  # 2Ô∏è‚É£ DEPLOY JOB
  # =========================
  deploy:
    name: Deploy to cPanel
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Clean hosting folder
        run: |
          ssh -p ${{ secrets.SSH_PORT }} \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
          "rm -rf ~/public_html/*"

      - name: Upload dist folder
        run: |
          scp -P ${{ secrets.SSH_PORT }} -r \
          dist/* \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/${{ secrets.SSH_USER }}/public_html

  # =========================
  # 3Ô∏è‚É£ DISCORD NOTIFICATION JOB
  # =========================
  notify:
    name: Discord Notification
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()

    steps:
      - name: Discord Logging (Embed)
        run: |
          BUILD_STATUS="${{ needs.build.result }}"
          DEPLOY_STATUS="${{ needs.deploy.result }}"

          if [[ "$DEPLOY_STATUS" == "success" ]]; then
            COLOR=5763719
            EMOJI="üöÄ"
            TITLE="Deployment Successful"
          elif [[ "$DEPLOY_STATUS" == "failure" ]]; then
            COLOR=15548997
            EMOJI="üí•"
            TITLE="Deployment Failed"
          else
            COLOR=16705372
            EMOJI="‚è∏Ô∏è"
            TITLE="Deployment Cancelled"
          fi

          curl -H "Content-Type: application/json" \
          -X POST \
          -d "{
            \"username\": \"CI/CD Logger\",
            \"avatar_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",
            \"embeds\": [{
              \"title\": \"$EMOJI $TITLE\",
              \"color\": $COLOR,
              \"fields\": [
                {
                  \"name\": \"üõ† Build Job\",
                  \"value\": \"**$BUILD_STATUS**\",
                  \"inline\": true
                },
                {
                  \"name\": \"üöÄ Deploy Job\",
                  \"value\": \"**$DEPLOY_STATUS**\",
                  \"inline\": true
                },
                {
                  \"name\": \"üåø Branch\",
                  \"value\": \"${{ github.ref_name }}\",
                  \"inline\": true
                },
                {
                  \"name\": \"üîó Commit\",
                  \"value\": \"[${GITHUB_SHA:0:7}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\"
                }
              ],
              \"footer\": {
                \"text\": \"GitHub Actions ‚Ä¢ Run #${{ github.run_number }}\"
              }
            }]
          }" \
          ${{ secrets.DISCORD_LOG_WEBHOOK }}

      - name: Discord Public Notification
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            üöÄ **Deploy ${{ github.repository }}**
            Build: **${{ needs.build.result }}**
            Deploy: **${{ needs.deploy.result }}**
            Branch: `${{ github.ref_name }}`
