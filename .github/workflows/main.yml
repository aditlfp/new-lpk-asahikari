name: Build & Deploy Vite to cPanel

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Ambil source code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Setup Node
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    # 3Ô∏è‚É£ Install dependency
    - name: Install dependencies
      run: npm install

    # 4Ô∏è‚É£ Build Vite
    - name: Build project & setup .env.production
      env:
        VITE_URL_SIGNUP: ${{ secrets.VITE_URL_SIGNUP }}
        VITE_URL_SIGIN: ${{ secrets.VITE_URL_SIGIN }}
      run: npm run build

    # 5Ô∏è‚É£ Setup SSH
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    # 6Ô∏è‚É£ Bersihkan public_html
    - name: Clean hosting folder
      run: |
        ssh -p ${{ secrets.SSH_PORT }} \
        ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
        "rm -rf ~/public_html/*"

    # 7Ô∏è‚É£ Upload hasil build SAJA (dist)
    - name: Upload dist folder
      run: |
        scp -P ${{ secrets.SSH_PORT }} -r \
          dist/* \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/${{ secrets.SSH_USER }}/public_html
    - name: üöÄ Discord Notification
      if: always()
      run: |
        STATUS="${{ job.status }}"
        WORKFLOW="${{ github.workflow }}"
        ACTOR="${{ github.actor }}"
        COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)
        
        # Status configuration
        if [ "$STATUS" = "success" ]; then
          COLOR=5763719  # Modern green
          EMOJI="‚ú®"
          STATUS_TEXT="Deployment Successful"
        elif [ "$STATUS" = "failure" ]; then
          COLOR=15548997  # Modern red
          EMOJI="üí•"
          STATUS_TEXT="Deployment Failed"
        else
          COLOR=16705372  # Modern orange
          EMOJI="‚è∏Ô∏è"
          STATUS_TEXT="Deployment Cancelled"
        fi
        
        # Build Discord embed
        curl -H "Content-Type: application/json" \
        -X POST \
        -d "{
          \"username\": \"CI/CD Pipeline\",
          \"avatar_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",
          \"embeds\": [{
            \"author\": {
              \"name\": \"$ACTOR\",
              \"icon_url\": \"https://github.com/$ACTOR.png\"
            },
            \"title\": \"$EMOJI $STATUS_TEXT\",
            \"description\": \"**$WORKFLOW** pipeline has completed\",
            \"color\": $COLOR,
            \"fields\": [
              {
                \"name\": \"üì¶ Repository\",
                \"value\": \"[\`${{ github.repository }}\`](https://github.com/${{ github.repository }})\",
                \"inline\": true
              },
              {
                \"name\": \"üåø Branch\",
                \"value\": \"[\`${{ github.ref_name }}\`](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }})\",
                \"inline\": true
              },
              {
                \"name\": \"üìù Commit Message\",
                \"value\": \"$COMMIT_MSG\"
              },
              {
                \"name\": \"üîó Commit Hash\",
                \"value\": \"[\`${GITHUB_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\",
                \"inline\": true
              },
              {
                \"name\": \"‚è±Ô∏è Duration\",
                \"value\": \"<t:${{ github.event.repository.pushed_at }}:R>\",
                \"inline\": true
              },
              {
                \"name\": \"üìä Status\",
                \"value\": \"**${STATUS^^}**\",
                \"inline\": false
              }
            ],
            \"thumbnail\": {
              \"url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\"
            },
            \"footer\": {
              \"text\": \"GitHub Actions ‚Ä¢ Run #${{ github.run_number }}\",
              \"icon_url\": \"https://github.githubassets.com/images/modules/site/features/actions-icon-actions.svg\"
            },
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
          }]
        }" \
        ${{ secrets.DISCORD_LOG_WEBHOOK }}
    
    - name: Discord notification
      if: always() # step ini tetap jalan meski gagal
      uses: Ilshidur/action-discord@master
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        DISCORD_USERNAME: "GitHub Actions Bot"
        DISCORD_AVATAR: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
      with:
          args: |
            üöÄ **CI/CD SSH status untuk ${{ github.repository }}**
            Branch: `${{ github.ref_name }}`
            Commit: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            Status: **${{ job.status }}**
